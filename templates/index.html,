<style>
    .media-btn { font-size: 24px; cursor: pointer; padding: 5px; color: var(--primary); }
    .msg-img { max-width: 200px; border-radius: 10px; margin-top: 5px; }
    audio { height: 35px; margin-top: 5px; }
    .recording { color: red; animation: blink 1s infinite; }
    @keyframes blink { 0% {opacity:1} 50% {opacity:0.3} 100% {opacity:1} }
</style>

<div class="footer">
    <label class="media-btn">üìé<input type="file" id="photo-input" hidden accept="image/*" onchange="sendPhoto()"></label>
    <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
    <div id="mic-btn" class="media-btn" onclick="toggleRecording()">üé§</div>
    <button onclick="sendText()">–û–¢–ü–†–ê–í–ò–¢–¨</button>
</div>

<script>
    let mediaRecorder;
    let audioChunks = [];

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞
    async function sendText() {
        const input = document.getElementById('msg-input');
        if(!input.value) return;
        await sendMessage({content: input.value, msg_type: 'text'});
        input.value = '';
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ
    function sendPhoto() {
        const file = document.getElementById('photo-input').files[0];
        const reader = new FileReader();
        reader.onloadend = async () => {
            await sendMessage({file_data: reader.result, msg_type: 'photo'});
        };
        reader.readAsDataURL(file);
    }

    // –ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–∞
    async function toggleRecording() {
        const btn = document.getElementById('mic-btn');
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const blob = new Blob(audioChunks, { type: 'audio/ogg' });
                const reader = new FileReader();
                reader.onloadend = async () => {
                    await sendMessage({file_data: reader.result, msg_type: 'audio'});
                };
                reader.readAsDataURL(blob);
                audioChunks = [];
            };
            mediaRecorder.start();
            btn.classList.add('recording');
        } else {
            mediaRecorder.stop();
            btn.classList.remove('recording');
        }
    }

    async function sendMessage(data) {
        await fetch('/send', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({...data, sender: currentUser})
        });
        loadMessages();
    }

    async function loadMessages() {
        const res = await fetch('/get_messages');
        const msgs = await res.json();
        const win = document.getElementById('chat-list');
        win.innerHTML = msgs.map(m => `
            <div class="chat-item">
                <div class="chat-info">
                    <b>${m.sender}</b><br>
                    ${m.msg_type === 'text' ? m.content : ''}
                    ${m.msg_type === 'photo' ? `<img src="${m.file_data}" class="msg-img">` : ''}
                    ${m.msg_type === 'audio' ? `<audio src="${m.file_data}" controls></audio>` : ''}
                </div>
            </div>
        `).join('');
    }
    setInterval(loadMessages, 3000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫
</script>

